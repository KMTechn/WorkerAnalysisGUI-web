<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¬ê³  ì›ì¥ - KMTech í†µí•© ëŒ€ì‹œë³´ë“œ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --info-color: #17a2b8;
            --nav-height: 40px;
        }

        * { box-sizing: border-box; }

        html {
            overflow-x: hidden;
            scroll-behavior: smooth;
        }

        body {
            background-color: #f5f6fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-top: var(--nav-height);
            min-width: 320px;
            overflow-x: hidden;
            -webkit-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }

        /* í†µí•© ë„¤ë¹„ê²Œì´ì…˜ - ëª¨ë˜ ë‹¤í¬ */
        .top-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--nav-height);
            background: #18181b;
            border-bottom: 1px solid #27272a;
            z-index: 1050;
            display: flex;
            align-items: center;
        }

        .top-nav-inner {
            width: 100%;
            max-width: 1800px;
            margin: 0 auto;
            padding: 0 1rem;
            display: flex;
            align-items: center;
        }

        /* ë¡œê³  ìŠ¤íƒ€ì¼ */
        .nav-logo {
            display: flex;
            align-items: center;
            margin-right: 1rem;
            text-decoration: none;
        }
        .logo-img {
            height: 28px;
            width: auto;
            object-fit: contain;
        }

        .top-nav .nav-link {
            color: #a1a1aa;
            text-decoration: none;
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            transition: all 0.2s;
            border-radius: 6px;
        }

        .top-nav .nav-link:hover { color: #fafafa; background: #27272a; }
        .top-nav .nav-link.active { color: #60a5fa; font-weight: 600; }
        .top-nav .nav-brand { margin-left: auto; color: #52525b; font-size: 0.85rem; }

        /* í—¤ë” - ëª¨ë˜ ë‹¤í¬ ê·¸ë¼ë°ì´ì…˜ */
        .page-header {
            background: linear-gradient(135deg, #1e1e2e 0%, #2d2d3d 50%, #3d3d4d 100%);
            color: white;
            padding: 1.25rem 0;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #404050;
        }

        .page-header h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
        }

        /* ì‹¤ì‹œê°„ ìƒíƒœ í‘œì‹œ */
        .realtime-status {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.85rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #6c757d;
            animation: pulse 2s infinite;
        }

        .status-dot.connected { background: var(--success-color); }
        .status-dot.disconnected { background: var(--danger-color); }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ë¹ ë¥¸ ë‚ ì§œ ì„ íƒ */
        .date-presets {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .date-preset-btn {
            padding: 0.4rem 0.8rem;
            border: 1px solid #dee2e6;
            background: white;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .date-preset-btn:hover {
            border-color: var(--secondary-color);
            color: var(--secondary-color);
        }

        .date-preset-btn.active {
            background: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
        }

        /* í•„í„° ì¹´ë“œ */
        .filter-card {
            background: white;
            border-radius: clamp(8px, 1.5vw, 12px);
            box-shadow: 0 2px 15px rgba(0,0,0,0.05);
            padding: clamp(0.75rem, 2vw, 1.25rem);
            margin-bottom: clamp(1rem, 3vw, 1.5rem);
        }

        .filter-card h6 {
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: clamp(0.5rem, 1.5vw, 0.75rem);
            font-size: clamp(0.8rem, 2vw, 0.9rem);
        }

        /* KPI ì¹´ë“œ */
        .kpi-card {
            background: white;
            border-radius: clamp(8px, 1.5vw, 12px);
            padding: clamp(0.75rem, 2vw, 1.25rem);
            box-shadow: 0 2px 15px rgba(0,0,0,0.05);
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .kpi-card .icon {
            font-size: clamp(1.25rem, 3vw, 1.5rem);
            margin-bottom: clamp(0.25rem, 1vw, 0.5rem);
        }

        .kpi-card .value {
            font-size: clamp(1.25rem, 4vw, 1.75rem);
            font-weight: 700;
            color: var(--primary-color);
            word-break: break-all;
        }

        .kpi-card .value.positive { color: var(--success-color); }
        .kpi-card .value.negative { color: var(--danger-color); }

        .kpi-card .label {
            font-size: clamp(0.7rem, 2vw, 0.85rem);
            color: #6c757d;
        }

        .kpi-card .change {
            font-size: clamp(0.65rem, 1.5vw, 0.75rem);
            margin-top: 0.25rem;
        }

        .kpi-card .change.up { color: var(--success-color); }
        .kpi-card .change.down { color: var(--danger-color); }

        /* íƒ­ ìŠ¤íƒ€ì¼ */
        .nav-tabs {
            border-bottom: 2px solid #dee2e6;
        }

        .nav-tabs .nav-link {
            color: var(--primary-color);
            font-weight: 500;
            border: none;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            padding: 0.75rem 1.25rem;
        }

        .nav-tabs .nav-link.active {
            color: var(--secondary-color);
            border-bottom-color: var(--secondary-color);
            background: none;
        }

        .nav-tabs .nav-link:hover:not(.active) {
            border-bottom-color: #adb5bd;
        }

        /* ë°ì´í„° ì¹´ë“œ */
        .data-card {
            background: white;
            border-radius: clamp(8px, 1.5vw, 12px);
            box-shadow: 0 2px 15px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        .data-card .card-header {
            background: var(--primary-color);
            color: white;
            padding: clamp(0.75rem, 2vw, 1rem) clamp(0.75rem, 2vw, 1.25rem);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .data-card .card-header .title {
            font-weight: 600;
            font-size: clamp(0.85rem, 2vw, 1rem);
        }

        .data-card .card-header .badge {
            background: var(--secondary-color);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: clamp(0.7rem, 1.5vw, 0.8rem);
        }

        /* í…Œì´ë¸” */
        .table-container {
            max-height: clamp(300px, 50vh, 500px);
            overflow-y: auto;
            overflow-x: auto;
        }

        .table thead th {
            position: sticky;
            top: 0;
            background: #f8f9fa;
            z-index: 10;
            font-weight: 600;
            color: var(--primary-color);
            font-size: 0.85rem;
            white-space: nowrap;
        }

        .table thead th.sortable {
            cursor: pointer;
            user-select: none;
            transition: background 0.15s;
        }

        .table thead th.sortable:hover {
            background: #e9ecef;
        }

        .table thead th.sortable::after {
            content: ' \u2195';
            opacity: 0.3;
            font-size: 0.7rem;
        }

        .table thead th.sortable.asc::after {
            content: ' \u25b2';
            opacity: 1;
        }

        .table thead th.sortable.desc::after {
            content: ' \u25bc';
            opacity: 1;
        }

        .table tbody tr {
            cursor: pointer;
            transition: background 0.15s;
        }

        .table tbody tr:hover {
            background: #e3f2fd;
        }

        .table td {
            font-size: 0.85rem;
            vertical-align: middle;
        }

        .qty-in { color: var(--success-color); font-weight: 600; }
        .qty-out { color: var(--danger-color); font-weight: 600; }

        /* íƒ€ì… ë°°ì§€ */
        .type-badge {
            display: inline-block;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .type-badge.receipt { background: #d1fae5; color: #065f46; }
        .type-badge.issue { background: #fee2e2; color: #991b1b; }
        .type-badge.transfer { background: #fef3c7; color: #92400e; }
        .type-badge.manufacture { background: #dbeafe; color: #1e40af; }
        .type-badge.return { background: #f3e8ff; color: #6b21a8; }

        /* ì²´í¬ë°•ìŠ¤ í•„í„° */
        .type-filter {
            display: inline-flex;
            align-items: center;
            padding: 0.3rem 0.6rem;
            border-radius: 16px;
            margin: 0.2rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #dee2e6;
            background: white;
        }

        .type-filter:hover { border-color: var(--secondary-color); }

        .type-filter.checked {
            background: #d1fae5;
            border-color: #86efac;
        }

        .type-filter.unchecked {
            background: #fee2e2;
            border-color: #fca5a5;
            text-decoration: line-through;
            opacity: 0.7;
        }

        .type-filter input { margin-right: 0.4rem; }

        /* ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ */
        .chart-card {
            background: white;
            border-radius: clamp(8px, 1.5vw, 12px);
            padding: clamp(0.75rem, 2vw, 1.25rem);
            box-shadow: 0 2px 15px rgba(0,0,0,0.05);
            height: 100%;
        }

        .chart-card h6 {
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: clamp(0.5rem, 2vw, 1rem);
            font-size: clamp(0.8rem, 2vw, 0.9rem);
        }

        .chart-container {
            position: relative;
            height: clamp(180px, 30vw, 250px);
            width: 100%;
        }

        /* ìµœê·¼ ê±°ë˜ í”¼ë“œ */
        .feed-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .feed-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid #f1f1f1;
            transition: background 0.15s;
        }

        .feed-item:hover { background: #f8f9fa; }
        .feed-item:last-child { border-bottom: none; }

        .feed-item .icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.75rem;
            font-size: 1rem;
        }

        .feed-item .icon.in { background: #d1fae5; color: var(--success-color); }
        .feed-item .icon.out { background: #fee2e2; color: var(--danger-color); }

        .feed-item .content { flex: 1; }
        .feed-item .content .title { font-weight: 500; font-size: 0.85rem; }
        .feed-item .content .subtitle { font-size: 0.75rem; color: #6c757d; }
        .feed-item .time { font-size: 0.7rem; color: #adb5bd; }

        /* í’ˆëª© ë“œë¦´ë‹¤ìš´ ëª¨ë‹¬ */
        .item-modal .modal-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .item-modal .stat-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .item-modal .stat-box {
            text-align: center;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .item-modal .stat-box .value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .item-modal .stat-box .label {
            font-size: 0.75rem;
            color: #6c757d;
        }

        /* í† ìŠ¤íŠ¸ ì•Œë¦¼ */
        .toast-container {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 1100;
        }

        .custom-toast {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            padding: 1rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            animation: slideIn 0.3s ease;
            max-width: 350px;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .custom-toast .icon {
            font-size: 1.25rem;
            margin-right: 0.75rem;
        }

        .custom-toast .content { flex: 1; }
        .custom-toast .title { font-weight: 600; font-size: 0.9rem; }
        .custom-toast .message { font-size: 0.8rem; color: #6c757d; }

        /* ë¡œë”© */
        .loading-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 0.75rem;
            z-index: 100;
        }

        .loading-overlay.active { display: flex; }

        .loading-overlay .loading-text {
            font-size: 0.85rem;
            color: var(--primary-color);
            font-weight: 500;
        }

        /* ì „ì²´ í˜ì´ì§€ ë¡œë”© */
        .page-loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.95);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 1rem;
            z-index: 2000;
        }

        .page-loading.active { display: flex; }

        .page-loading .loading-text {
            font-size: 1rem;
            color: var(--primary-color);
            font-weight: 500;
        }

        /* í˜„ì¬ ì¬ê³  íƒ­ */
        .stock-card {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 1px 5px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stock-card .item-info h6 {
            margin: 0;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .stock-card .item-info small {
            color: #6c757d;
        }

        .stock-card .qty {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .stock-card .qty.low { color: var(--warning-color); }
        .stock-card .qty.critical { color: var(--danger-color); font-weight: 800; }

        .stock-card.low-stock {
            border-left: 4px solid var(--warning-color);
            background: #fffbeb;
        }

        .stock-card.critical-stock {
            border-left: 4px solid var(--danger-color);
            background: #fef2f2;
            animation: pulse-warning 2s infinite;
        }

        @keyframes pulse-warning {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        /* ìë™ì™„ì„± ë“œë¡­ë‹¤ìš´ */
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .autocomplete-dropdown.show { display: block; }

        .autocomplete-item {
            padding: 0.6rem 0.8rem;
            cursor: pointer;
            border-bottom: 1px solid #f1f1f1;
            transition: background 0.15s;
        }

        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background: #e3f2fd;
        }

        .autocomplete-item:last-child { border-bottom: none; }

        .autocomplete-item .item-code {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--primary-color);
        }

        .autocomplete-item .item-name {
            font-size: 0.75rem;
            color: #6c757d;
        }

        /* ë²„íŠ¼ */
        .btn-export {
            background: var(--success-color);
            border: none;
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-size: 0.8rem;
        }

        .btn-export:hover {
            background: #219a52;
            color: white;
        }

        /* ì¤Œ ì¹œí™”ì  Wrapper */
        .zoom-wrapper {
            min-width: 320px;
            max-width: 1920px;
            margin: 0 auto;
            width: 100%;
            transform-origin: top center;
            overflow: visible;
        }

        .zoom-content {
            display: flex;
            flex-direction: column;
            padding: 0;
        }

        /* ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ ì»¨í…Œì´ë„ˆ ì¡°ì • */
        @media screen and (min-width: 1921px) {
            .zoom-wrapper {
                max-width: 95vw;
            }
        }

        /* ì‘ì€ í™”ë©´ì—ì„œ ì¤Œ ì•„ì›ƒ ì‹œì—ë„ ìµœì†Œ ë„ˆë¹„ ìœ ì§€ */
        @media screen and (max-width: 480px) {
            .zoom-wrapper {
                min-width: 100%;
            }
        }

        /* container í´ë˜ìŠ¤ ì¤Œ ëŒ€ì‘ */
        .zoom-content > .container,
        .zoom-content > header .container,
        .zoom-content > .page-header .container {
            max-width: 100%;
            width: 100%;
            padding-left: clamp(0.75rem, 3vw, 1.5rem);
            padding-right: clamp(0.75rem, 3vw, 1.5rem);
        }

        /* ì¤Œ ì‹œ ì¹´ë“œ ë° ê·¸ë¦¬ë“œ ë¹„ìœ¨ ìœ ì§€ */
        .zoom-content .row {
            margin-left: calc(-0.5 * clamp(0.5rem, 2vw, 1.5rem));
            margin-right: calc(-0.5 * clamp(0.5rem, 2vw, 1.5rem));
        }

        .zoom-content .row > [class*="col"] {
            padding-left: calc(0.5 * clamp(0.5rem, 2vw, 1.5rem));
            padding-right: calc(0.5 * clamp(0.5rem, 2vw, 1.5rem));
        }

        /* ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ ì¤Œ ëŒ€ì‘ */
        .chart-container canvas {
            max-width: 100% !important;
            height: auto !important;
        }

        /* íƒ­ ì½˜í…ì¸  í•˜ë‹¨ ì—¬ë°± */
        .tab-content {
            padding-bottom: 1.5rem;
        }

        /* í‘¸í„° */
        .site-footer {
            margin-top: 1rem;
            padding: 1.5rem 0;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            clear: both;
            position: relative;
            z-index: 1;
        }

        .site-footer .footer-content {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.75rem;
            color: #6c757d;
            font-size: 0.8rem;
        }

        .site-footer .separator {
            color: #dee2e6;
        }

        .site-footer .version {
            color: #adb5bd;
        }

        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            /* ë„¤ë¹„ê²Œì´ì…˜ */
            .top-nav { height: 44px; }
            .top-nav-inner { padding: 0 0.5rem; }
            .top-nav .nav-link {
                padding: 0.35rem 0.6rem;
                font-size: 0.75rem;
            }
            .top-nav .nav-brand {
                display: none;
            }
            .logo-img { height: 22px; }
            .nav-logo { margin-right: 0.5rem; }

            /* í˜ì´ì§€ í—¤ë” */
            .page-header {
                padding: 0.75rem 0;
                margin-bottom: 1rem;
            }
            .page-header h1 {
                font-size: 1rem;
                margin-bottom: 0.25rem;
            }
            .page-header .container {
                padding: 0 0.75rem;
            }

            /* ì‹¤ì‹œê°„ ìƒíƒœ */
            .realtime-status {
                font-size: 0.7rem;
                gap: 0.5rem;
                flex-wrap: wrap;
            }
            .realtime-status > span {
                white-space: nowrap;
            }
            .status-dot {
                width: 6px;
                height: 6px;
            }

            /* ë„¤ë¹„ê²Œì´ì…˜ ë†’ì´ì— ë§ì¶° body padding ì¡°ì • */
            body {
                padding-top: 44px;
            }

            /* KPI ì¹´ë“œ */
            .kpi-card .value { font-size: 1.1rem; }
            .kpi-card .label { font-size: 0.7rem; }
            .kpi-card { padding: 0.75rem; }

            /* ëª¨ë‹¬ */
            .item-modal .stat-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            /* ë‚ ì§œ ì„ íƒ */
            .date-presets { gap: 0.25rem; }
            .date-preset-btn { padding: 0.25rem 0.5rem; font-size: 0.65rem; }

            /* í•„í„° ì¹´ë“œ */
            .filter-card { padding: 0.75rem; }

            /* íƒ­ */
            .nav-tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            .nav-tabs .nav-link {
                padding: 0.5rem 0.75rem;
                font-size: 0.75rem;
                white-space: nowrap;
            }

            /* í…Œì´ë¸” */
            .table { font-size: 0.75rem; }
            .table th, .table td { padding: 0.4rem 0.3rem; }

            /* ëª¨ë°”ì¼ì—ì„œ í…Œì´ë¸” ì»¨í…Œì´ë„ˆ ìŠ¤í¬ë¡¤ ì œê±° (body ìŠ¤í¬ë¡¤ë§Œ ì‚¬ìš©) */
            .table-container {
                max-height: none !important;
                overflow-y: visible !important;
            }

            /* íŠ¸ë Œë“œ íƒ­ ë ˆì´ì•„ì›ƒ ê°œì„  */
            #trendTab .col-md-4,
            #trendTab .col-md-8 {
                width: 100%;
            }

            #trendTab .chart-container {
                height: 200px !important;
            }

            /* ì›”ë³„ ìƒì„¸ í…Œì´ë¸” ëª¨ë°”ì¼ ìµœì í™” */
            #trendTab .data-card {
                margin-top: 1rem;
            }

            #trendTab .data-card .card-header {
                padding: 0.5rem 0.75rem;
            }

            #trendTab .data-card .table th,
            #trendTab .data-card .table td {
                padding: 0.5rem 0.25rem;
                font-size: 0.7rem;
            }
        }

        @media (max-width: 576px) {
            .page-header h1 { font-size: 0.9rem; }
            .realtime-status { font-size: 0.65rem; gap: 0.4rem; }

            .site-footer .footer-content {
                flex-direction: column;
                gap: 0.25rem;
            }

            .site-footer .separator {
                display: none;
            }

            /* ë” ì‘ì€ í™”ë©´ìš© ì¶”ê°€ ì¡°ì • */
            .top-nav .nav-link {
                padding: 0.3rem 0.5rem;
                font-size: 0.7rem;
            }
            .kpi-card .value { font-size: 1rem; }
        }
    </style>
</head>
<body>
    <!-- í†µí•© ë„¤ë¹„ê²Œì´ì…˜ -->
    <nav class="top-nav">
        <div class="top-nav-inner">
            <a href="/" class="nav-logo">
                <img src="{{ url_for('static', filename='logo.png') }}" alt="KMTech" class="logo-img">
            </a>
            <a href="/" class="nav-link">ğŸ‘¥ ì‘ì—…ì ë¶„ì„</a>
            <a href="/stock/" class="nav-link active">ğŸ“¦ ì¬ê³  ì›ì¥</a>
            {% if not demo_mode %}
            <a href="/stock/demo" class="nav-link">ğŸ¬ ë°ëª¨</a>
            {% endif %}
            <span class="nav-brand">KMTech í†µí•© ëŒ€ì‹œë³´ë“œ</span>
        </div>
    </nav>

    <!-- ì¤Œ ì¹œí™”ì  Wrapper -->
    <div class="zoom-wrapper">
        <div class="zoom-content">
            <!-- í˜ì´ì§€ í—¤ë” -->
            <header class="page-header">
        <div class="container d-flex justify-content-between align-items-center">
            <h1><i class="bi bi-box-seam me-2"></i>ì¬ê³  ì›ì¥ ëŒ€ì‹œë³´ë“œ</h1>
            <div class="realtime-status">
                <span class="status-dot" id="statusDot"></span>
                <span id="connectionStatus">ì—°ê²° ì¤‘...</span>
                <span class="ms-3"><i class="bi bi-people me-1"></i><span id="viewerCount">1</span>ëª… ì ‘ì†</span>
                <span class="ms-3" id="lastUpdate">-</span>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- ë¹ ë¥¸ ë‚ ì§œ ì„ íƒ & í•„í„° (ëª¨ë°”ì¼ì—ì„œ ì ‘ê¸° ê°€ëŠ¥) -->
        <div class="filter-card">
            <!-- ëª¨ë°”ì¼ í•„í„° í† ê¸€ ë²„íŠ¼ -->
            <div class="d-md-none mb-2">
                <button class="btn btn-sm btn-outline-secondary w-100" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse" aria-expanded="false" aria-controls="filterCollapse" id="filterToggleBtn">
                    <i class="bi bi-funnel me-1"></i>í•„í„° ì—´ê¸° <i class="bi bi-chevron-down ms-1"></i>
                </button>
            </div>
            <!-- í•„í„° ë‚´ìš© (ëª¨ë°”ì¼ì—ì„œ ì ‘í˜, ë°ìŠ¤í¬íƒ‘ì—ì„œëŠ” í•­ìƒ í‘œì‹œ) -->
            <div class="collapse d-md-block" id="filterCollapse">
            <div class="row">
                <div class="col-lg-8">
                    <!-- ë¹ ë¥¸ ë‚ ì§œ ì„ íƒ -->
                    <h6><i class="bi bi-calendar3 me-2"></i>ê¸°ê°„ ì„ íƒ</h6>
                    <div class="date-presets mb-3">
                        <button class="date-preset-btn" data-days="0">ì˜¤ëŠ˜</button>
                        <button class="date-preset-btn" data-days="7">ìµœê·¼ 7ì¼</button>
                        <button class="date-preset-btn active" data-days="30">ìµœê·¼ 30ì¼</button>
                        <button class="date-preset-btn" data-days="90">ìµœê·¼ 3ê°œì›”</button>
                        <button class="date-preset-btn" data-days="180">ìµœê·¼ 6ê°œì›”</button>
                        <button class="date-preset-btn" data-days="365">ìµœê·¼ 1ë…„</button>
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-md-3">
                            <input type="date" id="fromDate" class="form-control form-control-sm" value="{{ default_from }}">
                        </div>
                        <div class="col-md-3">
                            <input type="date" id="toDate" class="form-control form-control-sm" value="{{ default_to }}">
                        </div>
                        <div class="col-md-3">
                            <select id="warehouse" class="form-select form-select-sm">
                                <option value="">ì „ì²´ ì°½ê³ </option>
                                {% for wh in warehouses %}
                                <option value="{{ wh.name }}">{{ wh.warehouse_name or wh.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <div class="position-relative">
                                <div class="input-group input-group-sm">
                                    <input type="text" id="itemSearch" class="form-control" placeholder="í’ˆëª© ê²€ìƒ‰..."
                                           autocomplete="off" onkeyup="handleItemSearch(event)" oninput="toggleClearBtn()">
                                    <button class="btn btn-outline-secondary" id="clearSearchBtn" onclick="clearSearch()" style="display: none;" title="ê²€ìƒ‰ì–´ ì§€ìš°ê¸°">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                    <button class="btn btn-primary" onclick="loadAllData()">
                                        <i class="bi bi-search"></i>
                                    </button>
                                </div>
                                <div class="autocomplete-dropdown" id="itemAutocomplete"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <h6><i class="bi bi-filter me-2"></i>ìœ í˜• í•„í„°
                        <span class="float-end">
                            <button type="button" class="btn btn-sm btn-outline-primary py-0 px-1" onclick="selectAllTypes(true)" title="ì „ì²´ ì„ íƒ">
                                <i class="bi bi-check-all"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary py-0 px-1" onclick="selectAllTypes(false)" title="ì „ì²´ í•´ì œ">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </span>
                    </h6>
                    <div id="typeFilters">
                        {% for type_key, type_name in entry_types.items() %}
                        <label class="type-filter {% if type_key not in default_exclude %}checked{% else %}unchecked{% endif %}">
                            <input type="checkbox" value="{{ type_key }}"
                                   {% if type_key not in default_exclude %}checked{% endif %}
                                   onchange="toggleTypeFilter(this)">
                            {{ type_name }}
                        </label>
                        {% endfor %}
                    </div>
                </div>
            </div>
            </div><!-- /filterCollapse -->
        </div>

        <!-- KPI ì¹´ë“œ -->
        <div class="row g-3 mb-4">
            <div class="col-6 col-md">
                <div class="kpi-card">
                    <div class="icon">ğŸ“¥</div>
                    <div class="value positive" id="kpiTotalIn">-</div>
                    <div class="label">ì´ ì…ê³ </div>
                    <div class="change up" id="kpiInChange">-</div>
                </div>
            </div>
            <div class="col-6 col-md">
                <div class="kpi-card">
                    <div class="icon">ğŸ“¤</div>
                    <div class="value negative" id="kpiTotalOut">-</div>
                    <div class="label">ì´ ì¶œê³ </div>
                    <div class="change down" id="kpiOutChange">-</div>
                </div>
            </div>
            <div class="col-6 col-md">
                <div class="kpi-card">
                    <div class="icon">ğŸ”§</div>
                    <div class="value" id="kpiDisassemble" style="color: #7c3aed;">-</div>
                    <div class="label">í•´ì²´ ìˆ˜ëŸ‰</div>
                    <div class="change">ë³„ë„ ì²˜ë¦¬</div>
                </div>
            </div>
            <div class="col-6 col-md">
                <div class="kpi-card">
                    <div class="icon">ğŸ“Š</div>
                    <div class="value" id="kpiNetChange">-</div>
                    <div class="label">ìˆœ ë³€ë™</div>
                    <div class="change" id="kpiNetChangePercent">-</div>
                </div>
            </div>
            <div class="col-6 col-md">
                <div class="kpi-card">
                    <div class="icon">ğŸ“‹</div>
                    <div class="value" id="kpiTransactions">-</div>
                    <div class="label">ê±°ë˜ ê±´ìˆ˜</div>
                    <div class="change" id="kpiItemCount">-</div>
                </div>
            </div>
        </div>

        <!-- ë©”ì¸ íƒ­ -->
        <ul class="nav nav-tabs mb-3" id="mainTabs" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#dashboardTab">
                    <i class="bi bi-speedometer2 me-1"></i>ëŒ€ì‹œë³´ë“œ
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#ledgerTab">
                    <i class="bi bi-list-ul me-1"></i>ìƒì„¸ ì›ì¥
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#summaryTab">
                    <i class="bi bi-bar-chart me-1"></i>í’ˆëª©ë³„ ìš”ì•½
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#currentStockTab">
                    <i class="bi bi-box me-1"></i>í˜„ì¬ ì¬ê³ 
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#trendTab">
                    <i class="bi bi-graph-up me-1"></i>íŠ¸ë Œë“œ
                </button>
            </li>
        </ul>

        <div class="tab-content">
            <!-- ëŒ€ì‹œë³´ë“œ íƒ­ -->
            <div class="tab-pane fade show active" id="dashboardTab">
                <div class="row g-3">
                    <!-- ì°¨íŠ¸ ì˜ì—­ -->
                    <div class="col-lg-8">
                        <div class="chart-card">
                            <h6><i class="bi bi-bar-chart me-2"></i>ì›”ë³„ ì…ì¶œê³  ì¶”ì´</h6>
                            <div class="chart-container">
                                <canvas id="monthlyChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="chart-card">
                            <h6><i class="bi bi-pie-chart me-2"></i>ì°½ê³ ë³„ ì¬ê³  ë¶„í¬</h6>
                            <div class="chart-container">
                                <canvas id="warehouseChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <!-- ìµœê·¼ ê±°ë˜ -->
                    <div class="col-lg-6">
                        <div class="chart-card">
                            <h6><i class="bi bi-clock-history me-2"></i>ìµœê·¼ ê±°ë˜</h6>
                            <div class="feed-list" id="recentFeed">
                                <div class="text-center text-muted py-4">ë°ì´í„° ë¡œë”© ì¤‘...</div>
                            </div>
                        </div>
                    </div>
                    <!-- ìƒìœ„ í’ˆëª© -->
                    <div class="col-lg-6">
                        <div class="chart-card">
                            <h6><i class="bi bi-trophy me-2"></i>ìƒìœ„ ì…ì¶œê³  í’ˆëª©</h6>
                            <div class="chart-container">
                                <canvas id="topItemsChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ìƒì„¸ ì›ì¥ íƒ­ -->
            <div class="tab-pane fade" id="ledgerTab">
                <div class="data-card">
                    <div class="card-header">
                        <span class="title"><i class="bi bi-table me-2"></i>ì¬ê³  ì›ì¥</span>
                        <div>
                            <span class="badge me-2" id="ledgerCount">0ê±´</span>
                            <button class="btn-export" onclick="exportExcel('ledger')">
                                <i class="bi bi-file-earmark-excel me-1"></i>Excel
                            </button>
                        </div>
                    </div>
                    <div class="position-relative">
                        <div class="loading-overlay" id="ledgerLoading">
                            <div class="spinner-border text-primary"></div>
                            <span class="loading-text">ë°ì´í„° ë¡œë”© ì¤‘...</span>
                        </div>
                        <div class="table-container">
                            <table class="table table-hover mb-0" id="ledgerTable">
                                <thead>
                                    <tr>
                                        <th class="sortable" data-sort="date" onclick="sortLedger('date')">ì¼ì‹œ</th>
                                        <th class="sortable" data-sort="item_code" onclick="sortLedger('item_code')">í’ˆëª©ì½”ë“œ</th>
                                        <th>í’ˆëª©ëª…</th>
                                        <th>ì°½ê³ </th>
                                        <th class="text-end sortable" data-sort="in_qty" onclick="sortLedger('in_qty')">ì…ê³ </th>
                                        <th class="text-end sortable" data-sort="out_qty" onclick="sortLedger('out_qty')">ì¶œê³ </th>
                                        <th class="text-end" style="color: #7c3aed;">í•´ì²´</th>
                                        <th class="text-end sortable" data-sort="balance_qty" onclick="sortLedger('balance_qty')">ì”ëŸ‰</th>
                                        <th>ìœ í˜•</th>
                                        <th>ì „í‘œë²ˆí˜¸</th>
                                    </tr>
                                </thead>
                                <tbody id="ledgerBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- í’ˆëª©ë³„ ìš”ì•½ íƒ­ -->
            <div class="tab-pane fade" id="summaryTab">
                <div class="data-card">
                    <div class="card-header">
                        <span class="title"><i class="bi bi-pie-chart me-2"></i>í’ˆëª©ë³„ ìš”ì•½</span>
                        <div>
                            <span class="badge me-2" id="summaryCount">0ê±´</span>
                            <button class="btn-export" onclick="exportExcel('summary')">
                                <i class="bi bi-file-earmark-excel me-1"></i>Excel
                            </button>
                        </div>
                    </div>
                    <div class="position-relative">
                        <div class="loading-overlay" id="summaryLoading">
                            <div class="spinner-border text-primary"></div>
                            <span class="loading-text">ë°ì´í„° ë¡œë”© ì¤‘...</span>
                        </div>
                        <div class="table-container">
                            <table class="table table-hover mb-0" id="summaryTable">
                                <thead>
                                    <tr>
                                        <th>í’ˆëª©ì½”ë“œ</th>
                                        <th>í’ˆëª©ëª…</th>
                                        <th class="text-end">ì´ ì…ê³ </th>
                                        <th class="text-end">ì´ ì¶œê³ </th>
                                        <th class="text-end">ìˆœ ì´ë™</th>
                                        <th class="text-end">ê±°ë˜ê±´ìˆ˜</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="summaryBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- í˜„ì¬ ì¬ê³  íƒ­ -->
            <div class="tab-pane fade" id="currentStockTab">
                <div class="row g-3">
                    <!-- ì¢Œì¸¡: í•„í„° + í˜„ì¬ ì¬ê³  í˜„í™© -->
                    <div class="col-md-4">
                        <div class="filter-card mb-3">
                            <h6><i class="bi bi-funnel me-2"></i>ì¬ê³  í•„í„°</h6>
                            <select id="stockWarehouse" class="form-select form-select-sm mb-2" onchange="loadCurrentStock()">
                                <option value="">ì „ì²´ ì°½ê³ </option>
                                {% for wh in warehouses %}
                                <option value="{{ wh.name }}">{{ wh.warehouse_name or wh.name }}</option>
                                {% endfor %}
                            </select>
                            <input type="text" id="stockItemSearch" class="form-control form-control-sm"
                                   placeholder="í’ˆëª© ê²€ìƒ‰..." onkeyup="filterCurrentStock()">
                        </div>
                        <div class="data-card">
                            <div class="card-header">
                                <span class="title"><i class="bi bi-box me-2"></i>í˜„ì¬ ì¬ê³  í˜„í™©</span>
                                <div>
                                    <span class="badge me-2" id="stockCount">0ê±´</span>
                                    <button class="btn btn-sm btn-success" onclick="exportCurrentStock()">
                                        <i class="bi bi-file-earmark-excel"></i>
                                    </button>
                                </div>
                            </div>
                            <!-- ìš”ì•½ ì •ë³´ -->
                            <div class="p-2 bg-light border-bottom">
                                <div class="row text-center small">
                                    <div class="col-6">
                                        <div class="fw-bold text-primary" id="stockTotalQty">0</div>
                                        <div class="text-muted">ì´ ì¬ê³ ëŸ‰</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="fw-bold text-danger" id="stockLowCount">0</div>
                                        <div class="text-muted">ë¶€ì¡± í’ˆëª©</div>
                                    </div>
                                </div>
                            </div>
                            <div class="p-3" id="currentStockList" style="max-height: 400px; overflow-y: auto;">
                                <div class="text-center text-muted py-4">ë°ì´í„° ë¡œë”© ì¤‘...</div>
                            </div>
                        </div>
                    </div>
                    <!-- ìš°ì¸¡: ì°½ê³ ë³„ í’ˆëª© ê·¸ë˜í”„ -->
                    <div class="col-md-8">
                        <div class="chart-card" style="height: 100%;">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0"><i class="bi bi-bar-chart-fill me-2"></i>ì°½ê³ ë³„ í’ˆëª© ë¶„í¬</h6>
                                <div class="d-flex gap-2">
                                    <select id="stockSortOrder" class="form-select form-select-sm" style="width: auto;" onchange="updateWarehouseItemChart()">
                                        <option value="qty-desc">ìˆ˜ëŸ‰ ë§ì€ìˆœ</option>
                                        <option value="qty-asc">ìˆ˜ëŸ‰ ì ì€ìˆœ</option>
                                        <option value="name-asc">ì´ë¦„ìˆœ</option>
                                    </select>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="loadCurrentStock()" title="ìƒˆë¡œê³ ì¹¨">
                                        <i class="bi bi-arrow-clockwise"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="chart-container" style="height: 480px;">
                                <canvas id="warehouseItemChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- íŠ¸ë Œë“œ íƒ­ -->
            <div class="tab-pane fade" id="trendTab">
                <div class="row g-3">
                    <!-- ì¢Œì¸¡: í’ˆëª© ì„ íƒ + ìš”ì•½ -->
                    <div class="col-lg-3 col-md-4">
                        <div class="filter-card">
                            <h6><i class="bi bi-search me-2"></i>í’ˆëª© ì„ íƒ</h6>
                            <select id="trendItemSelect" class="form-select" onchange="loadItemTrend()">
                                <option value="">í’ˆëª©ì„ ì„ íƒí•˜ì„¸ìš”</option>
                            </select>
                            <div id="trendItemInfo" class="mt-3" style="display: none;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                                    <div class="text-center p-2 bg-light rounded">
                                        <div class="h5 mb-0 text-success" id="trendTotalIn">-</div>
                                        <div class="small text-muted">ì´ ì…ê³ </div>
                                    </div>
                                    <div class="text-center p-2 bg-light rounded">
                                        <div class="h5 mb-0 text-danger" id="trendTotalOut">-</div>
                                        <div class="small text-muted">ì´ ì¶œê³ </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- ìš°ì¸¡: ì°¨íŠ¸ + í…Œì´ë¸” -->
                    <div class="col-lg-9 col-md-8">
                        <!-- ì°¨íŠ¸ -->
                        <div class="chart-card mb-3" style="height: auto;">
                            <h6><i class="bi bi-graph-up me-2"></i>ì›”ë³„ ì…ì¶œê³  íŠ¸ë Œë“œ</h6>
                            <div class="chart-container" style="height: 220px;">
                                <canvas id="trendChart"></canvas>
                            </div>
                        </div>
                        <!-- ì›”ë³„ ìƒì„¸ í…Œì´ë¸” (ê³ ì • ë†’ì´ + ìŠ¤í¬ë¡¤) -->
                        <div class="card mb-5" style="overflow: hidden;">
                            <div class="card-header bg-secondary text-white py-2">
                                <i class="bi bi-table me-2"></i>ì›”ë³„ ìƒì„¸
                            </div>
                            <div class="card-body p-0" style="max-height: 450px; overflow-y: auto;">
                                <table class="table table-sm table-hover table-striped mb-0">
                                    <thead class="table-light" style="position: sticky; top: 0;">
                                        <tr>
                                            <th class="ps-3">ì›”</th>
                                            <th class="text-end">ì…ê³ </th>
                                            <th class="text-end">ì¶œê³ </th>
                                            <th class="text-end">ìˆœë³€ë™</th>
                                            <th class="text-end pe-3">ê±°ë˜ê±´ìˆ˜</th>
                                        </tr>
                                    </thead>
                                    <tbody id="trendTableBody">
                                        <tr>
                                            <td colspan="5" class="text-center text-muted py-3">í’ˆëª©ì„ ì„ íƒí•˜ì„¸ìš”</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- í’ˆëª© ìƒì„¸ ëª¨ë‹¬ -->
    <div class="modal fade item-modal" id="itemModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="itemModalTitle">í’ˆëª© ìƒì„¸</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="stat-grid" id="itemModalStats"></div>
                    <div class="chart-container mb-3" style="height: 200px;">
                        <canvas id="itemModalChart"></canvas>
                    </div>
                    <h6><i class="bi bi-clock-history me-2"></i>ìµœê·¼ ê±°ë˜ ë‚´ì—­</h6>
                    <div class="table-container" style="max-height: 200px;">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>ì¼ì‹œ</th>
                                    <th>ìœ í˜•</th>
                                    <th class="text-end">ìˆ˜ëŸ‰</th>
                                    <th>ì°½ê³ </th>
                                </tr>
                            </thead>
                            <tbody id="itemModalHistory"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- í† ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- í‘¸í„° -->
    <footer class="site-footer">
        <div class="container">
            <div class="footer-content">
                <span class="copyright">&copy; 2026 KMTech. All rights reserved.</span>
                <span class="separator">|</span>
                <span class="version">ì¬ê³  ì›ì¥ ëŒ€ì‹œë³´ë“œ v2.0</span>
            </div>
        </div>
    </footer>

        </div><!-- /.zoom-content -->
    </div><!-- /.zoom-wrapper -->

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ========== ì„¤ì • ==========
        const API_BASE = '/stock/';
        const DEMO_MODE = {{ 'true' if demo_mode else 'false' }};
        const REFRESH_INTERVAL = 30000; // 30ì´ˆ

        // ========== ìƒíƒœ ==========
        let state = {
            ledgerData: [],
            summaryData: [],
            currentStockData: [],
            charts: {},
            socket: null,
            refreshTimer: null
        };

        // ========== ì´ˆê¸°í™” ==========
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ ì¬ê³  ì›ì¥ ëŒ€ì‹œë³´ë“œ v2 ë¡œë“œ', DEMO_MODE ? '(ë°ëª¨ ëª¨ë“œ)' : '');
            initDatePresets();
            initSocket();
            loadAllData();
            startAutoRefresh();

            // ëª¨ë°”ì¼ í•„í„° í† ê¸€ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            const filterCollapse = document.getElementById('filterCollapse');
            const filterToggleBtn = document.getElementById('filterToggleBtn');
            if (filterCollapse && filterToggleBtn) {
                filterCollapse.addEventListener('show.bs.collapse', function() {
                    filterToggleBtn.innerHTML = '<i class="bi bi-funnel-fill me-1"></i>í•„í„° ë‹«ê¸° <i class="bi bi-chevron-up ms-1"></i>';
                });
                filterCollapse.addEventListener('hide.bs.collapse', function() {
                    filterToggleBtn.innerHTML = '<i class="bi bi-funnel me-1"></i>í•„í„° ì—´ê¸° <i class="bi bi-chevron-down ms-1"></i>';
                });
            }
        });

        // ========== Socket.IO ==========
        function initSocket() {
            // ë°ëª¨ ëª¨ë“œì—ì„œëŠ” ì‹¤ì‹œê°„ ì—°ê²° ë¶ˆí•„ìš”
            if (DEMO_MODE) {
                updateConnectionStatus(false, true);  // ë°ëª¨ ëª¨ë“œ í‘œì‹œ
                return;
            }

            if (typeof io === 'undefined') {
                updateConnectionStatus(false);
                return;
            }

            try {
                state.socket = io('/stock', {
                    transports: ['websocket', 'polling'],
                    reconnection: true
                });

                state.socket.on('connect', () => {
                    updateConnectionStatus(true);
                });

                state.socket.on('disconnect', () => {
                    updateConnectionStatus(false);
                });

                state.socket.on('stock_update', (data) => {
                    showToast('ìƒˆ ê±°ë˜ ë“±ë¡', `${data.item_code} ${data.qty > 0 ? '+' : ''}${data.qty}ê°œ`, data.qty > 0 ? 'in' : 'out');
                    loadAllData();
                });

                state.socket.on('viewer_count', (count) => {
                    document.getElementById('viewerCount').textContent = count;
                });
            } catch (e) {
                console.warn('Socket.IO ì—°ê²° ì‹¤íŒ¨:', e);
                updateConnectionStatus(false);
            }
        }

        function updateConnectionStatus(connected, isDemo = false) {
            const dot = document.getElementById('statusDot');
            const status = document.getElementById('connectionStatus');

            if (isDemo) {
                dot.className = 'status-dot';
                dot.style.background = '#f39c12';  // ì£¼í™©ìƒ‰ (ë°ëª¨)
                status.textContent = 'ë°ëª¨ ëª¨ë“œ';
            } else if (connected) {
                dot.className = 'status-dot connected';
                dot.style.background = '';
                status.textContent = 'ì‹¤ì‹œê°„ ì—°ê²°ë¨';
            } else {
                dot.className = 'status-dot disconnected';
                dot.style.background = '';
                status.textContent = 'í´ë§ ëª¨ë“œ';
            }
        }

        // ========== ìë™ ìƒˆë¡œê³ ì¹¨ ==========
        function startAutoRefresh() {
            if (state.refreshTimer) clearInterval(state.refreshTimer);
            state.refreshTimer = setInterval(() => {
                loadAllData(true);
            }, REFRESH_INTERVAL);
        }

        // ========== ë‚ ì§œ í”„ë¦¬ì…‹ ==========
        function initDatePresets() {
            document.querySelectorAll('.date-preset-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.date-preset-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    const days = parseInt(this.dataset.days);
                    const today = new Date();
                    const fromDate = new Date();
                    fromDate.setDate(today.getDate() - days);

                    document.getElementById('fromDate').value = fromDate.toISOString().split('T')[0];
                    document.getElementById('toDate').value = today.toISOString().split('T')[0];

                    loadAllData();
                });
            });
        }

        // ========== í•„í„° ==========
        function getFilters() {
            const excludeTypes = [];
            document.querySelectorAll('#typeFilters input:not(:checked)').forEach(cb => {
                excludeTypes.push(cb.value);
            });

            return {
                fromDate: document.getElementById('fromDate').value,
                toDate: document.getElementById('toDate').value,
                warehouse: document.getElementById('warehouse').value,
                itemSearch: document.getElementById('itemSearch').value,
                excludeTypes
            };
        }

        function buildQueryString(filters) {
            const params = new URLSearchParams();
            params.append('from_date', filters.fromDate);
            params.append('to_date', filters.toDate);
            if (filters.warehouse) params.append('warehouse', filters.warehouse);
            if (filters.itemSearch) params.append('item_search', filters.itemSearch);
            filters.excludeTypes.forEach(t => params.append('exclude_types', t));
            return params.toString();
        }

        function toggleTypeFilter(checkbox) {
            const label = checkbox.parentElement;
            if (checkbox.checked) {
                label.classList.remove('unchecked');
                label.classList.add('checked');
            } else {
                label.classList.remove('checked');
                label.classList.add('unchecked');
            }
            loadAllData();
        }

        function selectAllTypes(selectAll) {
            document.querySelectorAll('#typeFilters input[type="checkbox"]').forEach(cb => {
                cb.checked = selectAll;
                const label = cb.parentElement;
                if (selectAll) {
                    label.classList.remove('unchecked');
                    label.classList.add('checked');
                } else {
                    label.classList.remove('checked');
                    label.classList.add('unchecked');
                }
            });
            loadAllData();
        }

        // ========== ë°ì´í„° ë¡œë”© ==========
        async function loadAllData(silent = false) {
            const filters = getFilters();

            // ë‚ ì§œ ìœ íš¨ì„± ê²€ì‚¬
            if (filters.fromDate > filters.toDate) {
                showToast('ê²½ê³ ', 'ì‹œì‘ì¼ì´ ì¢…ë£Œì¼ë³´ë‹¤ ëŠ¦ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            if (!silent) {
                document.getElementById('ledgerLoading').classList.add('active');
                document.getElementById('summaryLoading').classList.add('active');
            }

            try {
                // ì›ì¥ ë¨¼ì € ë¡œë“œ (ìš”ì•½ ê³„ì‚°ì— í•„ìš”)
                await loadLedger(filters);

                // ë‚˜ë¨¸ì§€ ë³‘ë ¬ ë¡œë“œ
                await Promise.all([
                    loadSummary(filters),
                    loadCurrentStock()
                ]);

                updateKPIs();
                updateCharts();
                updateLastUpdate();
                populateTrendSelect();

                // í’ˆëª© ê²€ìƒ‰ ì‹œ ìë™ìœ¼ë¡œ íŠ¸ë Œë“œ ì—°ë™
                autoSelectTrendItem(filters.itemSearch);

            } catch (error) {
                console.error('ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:', error);
                showToast('ì˜¤ë¥˜', 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
            } finally {
                document.getElementById('ledgerLoading').classList.remove('active');
                document.getElementById('summaryLoading').classList.remove('active');
            }
        }

        async function loadLedger(filters) {
            const endpoint = DEMO_MODE ? 'api/demo/stock-ledger' : 'api/stock-ledger';
            const response = await fetch(API_BASE + endpoint + '?' + buildQueryString(filters));
            const result = await response.json();

            state.ledgerData = result.data || [];
            renderLedger();
            document.getElementById('ledgerCount').textContent = result.count + 'ê±´';
        }

        async function loadSummary(filters) {
            if (DEMO_MODE) {
                // ë°ëª¨ ëª¨ë“œ: ì›ì¥ ë°ì´í„°ë¡œë¶€í„° ìš”ì•½ ê³„ì‚° (í•„í„° ì¼ê´€ì„± ìœ ì§€)
                calculateSummaryFromLedger();
            } else {
                const endpoint = 'api/stock-summary';
                const response = await fetch(API_BASE + endpoint + '?' + buildQueryString(filters));
                const result = await response.json();
                state.summaryData = result.data || [];
            }
            renderSummary();
            document.getElementById('summaryCount').textContent = state.summaryData.length + 'ê±´';
        }

        function calculateSummaryFromLedger() {
            // ì›ì¥ ë°ì´í„°ë¡œë¶€í„° í’ˆëª©ë³„ ìš”ì•½ ê³„ì‚°
            const itemMap = {};

            state.ledgerData.forEach(row => {
                const itemCode = row.base_item_code || row.item_code;
                if (!itemMap[itemCode]) {
                    itemMap[itemCode] = {
                        item_code: itemCode,
                        item_name: row.item_name || '',
                        total_in: 0,
                        total_out: 0,
                        transaction_count: 0
                    };
                }
                itemMap[itemCode].total_in += row.in_qty || 0;
                itemMap[itemCode].total_out += row.out_qty || 0;
                itemMap[itemCode].transaction_count++;
            });

            state.summaryData = Object.values(itemMap).sort((a, b) => b.total_in - a.total_in);
        }

        async function loadCurrentStock() {
            const endpoint = DEMO_MODE ? 'api/demo/current-stock' : 'api/current-stock';
            const warehouse = document.getElementById('stockWarehouse')?.value || '';
            const params = warehouse ? `?warehouse=${encodeURIComponent(warehouse)}` : '';

            const response = await fetch(API_BASE + endpoint + params);
            const result = await response.json();

            state.currentStockData = result.data || [];
            renderCurrentStock();
            updateWarehouseItemChart();
            document.getElementById('stockCount').textContent = result.count + 'ê±´';
        }

        // ========== ì •ë ¬ ==========
        let sortState = { column: 'date', direction: 'desc' };

        function sortLedger(column) {
            // ê°™ì€ ì»¬ëŸ¼ í´ë¦­ ì‹œ ë°©í–¥ ì „í™˜
            if (sortState.column === column) {
                sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.column = column;
                sortState.direction = 'asc';
            }

            // í—¤ë” ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            document.querySelectorAll('#ledgerTable th.sortable').forEach(th => {
                th.classList.remove('asc', 'desc');
                if (th.dataset.sort === column) {
                    th.classList.add(sortState.direction);
                }
            });

            // ë°ì´í„° ì •ë ¬
            state.ledgerData.sort((a, b) => {
                let valA = a[column];
                let valB = b[column];

                // ìˆ«ì ë¹„êµ
                if (typeof valA === 'number' && typeof valB === 'number') {
                    return sortState.direction === 'asc' ? valA - valB : valB - valA;
                }

                // ë¬¸ìì—´ ë¹„êµ
                valA = String(valA || '');
                valB = String(valB || '');
                return sortState.direction === 'asc'
                    ? valA.localeCompare(valB)
                    : valB.localeCompare(valA);
            });

            renderLedger();
        }

        // ========== ë Œë”ë§ ==========
        function renderLedger() {
            const tbody = document.getElementById('ledgerBody');
            tbody.innerHTML = '';

            if (state.ledgerData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="text-center text-muted py-5">
                            <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                            ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.<br>
                            <small>í•„í„° ì¡°ê±´ì„ ë³€ê²½í•´ ë³´ì„¸ìš”.</small>
                        </td>
                    </tr>
                `;
                renderRecentFeed();
                return;
            }

            state.ledgerData.slice(0, 200).forEach(row => {
                const tr = document.createElement('tr');
                tr.onclick = () => showItemModal(row.item_code, row.item_name);
                // í•´ì²´ ìˆ˜ëŸ‰ ê³„ì‚° (ì¶œê³  or ì…ê³  ì¤‘ ê°’ì´ ìˆëŠ” ê²ƒ)
                const disassembleQty = (row.disassemble_out_qty || 0) + (row.disassemble_in_qty || 0);
                tr.innerHTML = `
                    <td>${formatDate(row.date)}</td>
                    <td><code>${row.base_item_code || row.item_code}</code></td>
                    <td>${row.item_name || ''}</td>
                    <td><small>${row.warehouse || ''}</small></td>
                    <td class="text-end qty-in">${row.in_qty ? row.in_qty.toLocaleString() : ''}</td>
                    <td class="text-end qty-out">${row.out_qty ? row.out_qty.toLocaleString() : ''}</td>
                    <td class="text-end" style="color: #7c3aed; font-weight: 600;">${disassembleQty ? disassembleQty.toLocaleString() : ''}</td>
                    <td class="text-end">${row.balance_qty ? row.balance_qty.toLocaleString() : ''}</td>
                    <td>${getTypeBadge(row.stock_entry_type_kr, row.stock_entry_type)}</td>
                    <td><small class="text-muted">${row.voucher_no || ''}</small></td>
                `;
                tbody.appendChild(tr);
            });

            // ìµœê·¼ í”¼ë“œ ì—…ë°ì´íŠ¸
            renderRecentFeed();
        }

        function renderSummary() {
            const tbody = document.getElementById('summaryBody');
            tbody.innerHTML = '';

            if (state.summaryData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted py-5">
                            <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                            ìš”ì•½ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.<br>
                            <small>í•„í„° ì¡°ê±´ì„ ë³€ê²½í•´ ë³´ì„¸ìš”.</small>
                        </td>
                    </tr>
                `;
                return;
            }

            state.summaryData.forEach(row => {
                const netMove = (row.total_in || 0) - (row.total_out || 0);
                const tr = document.createElement('tr');
                tr.onclick = () => showItemModal(row.item_code, row.item_name);
                tr.innerHTML = `
                    <td><code>${row.item_code}</code></td>
                    <td>${row.item_name || ''}</td>
                    <td class="text-end qty-in">${(row.total_in || 0).toLocaleString()}</td>
                    <td class="text-end qty-out">${(row.total_out || 0).toLocaleString()}</td>
                    <td class="text-end ${netMove >= 0 ? 'qty-in' : 'qty-out'}">${netMove.toLocaleString()}</td>
                    <td class="text-end">${row.transaction_count || 0}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); showItemTrend('${row.item_code}')">
                            <i class="bi bi-graph-up"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderCurrentStock() {
            const container = document.getElementById('currentStockList');
            const searchTerm = document.getElementById('stockItemSearch')?.value?.toLowerCase() || '';

            const filtered = state.currentStockData.filter(item =>
                !searchTerm ||
                item.item_code.toLowerCase().includes(searchTerm) ||
                (item.item_name && item.item_name.toLowerCase().includes(searchTerm))
            );

            // ìš”ì•½ ì •ë³´ ì—…ë°ì´íŠ¸
            const totalQty = filtered.reduce((sum, item) => sum + (item.current_qty || 0), 0);
            const lowCount = filtered.filter(item => item.current_qty < 100).length;
            document.getElementById('stockTotalQty').textContent = totalQty.toLocaleString();
            document.getElementById('stockLowCount').textContent = lowCount;

            if (filtered.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-4">ì¬ê³  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }

            container.innerHTML = filtered.map(item => {
                const qtyClass = item.current_qty < 100 ? 'critical' : item.current_qty < 500 ? 'low' : '';
                const cardClass = item.current_qty < 100 ? 'critical-stock' : item.current_qty < 500 ? 'low-stock' : '';
                const displayCode = item.item_code.replace(/_UNPACK$/, '').replace(/_REPACK$/, '');
                return `
                    <div class="stock-card ${cardClass}" onclick="showItemModal('${item.item_code}', '${item.item_name}')">
                        <div class="item-info">
                            <h6><code>${displayCode}</code></h6>
                            <small>${item.item_name || ''}</small>
                            <br><small class="text-muted">${item.warehouse}</small>
                        </div>
                        <div class="qty ${qtyClass}">${(item.current_qty || 0).toLocaleString()}</div>
                    </div>
                `;
            }).join('');
        }

        function exportCurrentStock() {
            const warehouse = document.getElementById('stockWarehouse')?.value || '';
            const params = warehouse ? `?warehouse=${encodeURIComponent(warehouse)}` : '';
            window.location.href = API_BASE + 'api/export-current-stock' + params;
        }

        function renderRecentFeed() {
            const container = document.getElementById('recentFeed');
            const recent = state.ledgerData.slice(0, 10);

            if (recent.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-4">ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }

            container.innerHTML = recent.map(item => {
                const isIn = item.in_qty > 0;
                const qty = isIn ? item.in_qty : item.out_qty;
                return `
                    <div class="feed-item" onclick="showItemModal('${item.item_code}', '${item.item_name}')">
                        <div class="icon ${isIn ? 'in' : 'out'}">${isIn ? 'ğŸ“¥' : 'ğŸ“¤'}</div>
                        <div class="content">
                            <div class="title">${item.item_code}</div>
                            <div class="subtitle">${isIn ? '+' : '-'}${qty.toLocaleString()}ê°œ Â· ${item.warehouse}</div>
                        </div>
                        <div class="time">${formatTime(item.date)}</div>
                    </div>
                `;
            }).join('');
        }

        function filterCurrentStock() {
            renderCurrentStock();
            updateWarehouseItemChart();
        }

        // ========== KPI ì—…ë°ì´íŠ¸ ==========
        function updateKPIs() {
            let totalIn = 0, totalOut = 0, totalDisassemble = 0;

            state.ledgerData.forEach(row => {
                totalIn += row.in_qty || 0;
                totalOut += row.out_qty || 0;
                totalDisassemble += (row.disassemble_out_qty || 0) + (row.disassemble_in_qty || 0);
            });

            const netChange = totalIn - totalOut;
            const netPercent = totalOut > 0 ? ((netChange / totalOut) * 100).toFixed(1) : 0;

            document.getElementById('kpiTotalIn').textContent = totalIn.toLocaleString();
            document.getElementById('kpiTotalOut').textContent = totalOut.toLocaleString();
            document.getElementById('kpiNetChange').textContent = (netChange >= 0 ? '+' : '') + netChange.toLocaleString();
            document.getElementById('kpiNetChange').className = 'value ' + (netChange >= 0 ? 'positive' : 'negative');
            document.getElementById('kpiTransactions').textContent = state.ledgerData.length.toLocaleString();
            document.getElementById('kpiItemCount').textContent = state.summaryData.length + 'ê°œ í’ˆëª©';

            // í•´ì²´ ìˆ˜ëŸ‰ í‘œì‹œ
            const kpiDisassemble = document.getElementById('kpiDisassemble');
            if (kpiDisassemble) {
                kpiDisassemble.textContent = totalDisassemble.toLocaleString();
            }

            // íŠ¸ë Œë“œ í™”ì‚´í‘œ ì¶”ê°€
            const inChange = document.getElementById('kpiInChange');
            const outChange = document.getElementById('kpiOutChange');
            const netChangePercent = document.getElementById('kpiNetChangePercent');

            if (inChange) {
                inChange.innerHTML = totalIn > 0 ? '<i class="bi bi-arrow-up"></i> ì…ê³  ì¦ê°€' : '-';
                inChange.className = 'change up';
            }
            if (outChange) {
                outChange.innerHTML = totalOut > 0 ? '<i class="bi bi-arrow-down"></i> ì¶œê³  ë°œìƒ' : '-';
                outChange.className = 'change down';
            }
            if (netChangePercent) {
                const arrow = netChange >= 0 ? 'bi-arrow-up' : 'bi-arrow-down';
                netChangePercent.innerHTML = `<i class="bi ${arrow}"></i> ${Math.abs(netPercent)}%`;
                netChangePercent.className = 'change ' + (netChange >= 0 ? 'up' : 'down');
            }
        }

        // ========== ì°¨íŠ¸ ==========
        function updateCharts() {
            updateMonthlyChart();
            updateWarehouseChart();
            updateTopItemsChart();
        }

        function updateMonthlyChart() {
            const ctx = document.getElementById('monthlyChart');
            if (!ctx) return;

            // ì›”ë³„ ì§‘ê³„
            const monthlyData = {};
            state.ledgerData.forEach(row => {
                const month = row.date ? row.date.substring(0, 7) : 'Unknown';
                if (!monthlyData[month]) monthlyData[month] = { in: 0, out: 0, disassemble: 0 };
                monthlyData[month].in += row.in_qty || 0;
                monthlyData[month].out += row.out_qty || 0;
                monthlyData[month].disassemble += (row.disassemble_out_qty || 0) + (row.disassemble_in_qty || 0);
            });

            const labels = Object.keys(monthlyData).sort().slice(-6);
            const inData = labels.map(m => monthlyData[m]?.in || 0);
            const outData = labels.map(m => monthlyData[m]?.out || 0);
            const disassembleData = labels.map(m => monthlyData[m]?.disassemble || 0);

            if (state.charts.monthly) state.charts.monthly.destroy();

            state.charts.monthly = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'ì…ê³ ', data: inData, backgroundColor: 'rgba(39, 174, 96, 0.7)' },
                        { label: 'ì¶œê³ ', data: outData, backgroundColor: 'rgba(231, 76, 60, 0.7)' },
                        { label: 'í•´ì²´', data: disassembleData, backgroundColor: 'rgba(124, 58, 237, 0.7)' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function updateWarehouseChart() {
            const ctx = document.getElementById('warehouseChart');
            if (!ctx) return;

            // ì°½ê³ ë³„ ì§‘ê³„
            const warehouseData = {};
            state.currentStockData.forEach(row => {
                const wh = row.warehouse || 'Unknown';
                if (!warehouseData[wh]) warehouseData[wh] = 0;
                warehouseData[wh] += row.current_qty || 0;
            });

            const labels = Object.keys(warehouseData);
            const data = Object.values(warehouseData);
            const colors = ['#3498db', '#27ae60', '#f39c12', '#e74c3c', '#9b59b6', '#1abc9c'];

            if (state.charts.warehouse) state.charts.warehouse.destroy();

            state.charts.warehouse = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { boxWidth: 12 } } }
                }
            });
        }

        function updateWarehouseItemChart() {
            const ctx = document.getElementById('warehouseItemChart');
            if (!ctx) return;

            const selectedWarehouse = document.getElementById('stockWarehouse')?.value || '';
            const searchTerm = document.getElementById('stockItemSearch')?.value?.toLowerCase() || '';

            // ê²€ìƒ‰ì–´ë¡œ í•„í„°ë§ëœ ë°ì´í„°
            const filteredData = state.currentStockData.filter(item =>
                !searchTerm ||
                item.item_code.toLowerCase().includes(searchTerm) ||
                (item.item_name && item.item_name.toLowerCase().includes(searchTerm))
            );

            if (state.charts.warehouseItem) state.charts.warehouseItem.destroy();

            if (!selectedWarehouse) {
                // ì „ì²´ ì°½ê³ : ì°½ê³ ë³„ ì „ì²´ ìˆ˜ëŸ‰ (TEST ì œì™¸)
                const warehouseTotal = {};

                filteredData.forEach(row => {
                    const wh = row.warehouse || 'Unknown';
                    // ì°½ê³ ëª…ì—ì„œ ì•ë¶€ë¶„ ì¶”ì¶œ (ì˜ˆ: "ì…ê³ ì°½ê³  - K" -> "ì…ê³ ì°½ê³ ")
                    const whName = wh.split(' - ')[0].trim();

                    // TEST ì œì™¸
                    if (whName.toUpperCase().includes('TEST')) return;

                    warehouseTotal[whName] = (warehouseTotal[whName] || 0) + (row.current_qty || 0);
                });

                const labels = Object.keys(warehouseTotal);
                const data = labels.map(wh => warehouseTotal[wh] || 0);
                const colors = {
                    'ì…ê³ ì°½ê³ ': '#3498db',
                    'í•´ì²´ì‹¤': '#9b59b6',
                    'ë¶ˆëŸ‰ì°½ê³ ': '#e74c3c',
                    'ì¶œê³ ëŒ€ê¸°': '#27ae60'
                };

                state.charts.warehouseItem = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'ì¬ê³ ëŸ‰',
                            data: data,
                            backgroundColor: labels.map(l => colors[l] || '#95a5a6'),
                            borderColor: '#fff',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `ì¬ê³ ëŸ‰: ${context.raw.toLocaleString()}`;
                                    }
                                }
                            },
                            datalabels: {
                                anchor: 'end',
                                align: 'top',
                                color: '#333',
                                font: { weight: 'bold', size: 12 },
                                formatter: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        },
                        scales: {
                            x: { ticks: { font: { size: 12 } } },
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'ì¬ê³ ëŸ‰', font: { size: 11 } }
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            } else {
                // íŠ¹ì • ì°½ê³  ì„ íƒ: í’ˆëª©ë³„ ì¬ê³ ëŸ‰
                const itemQty = {};
                filteredData.forEach(row => {
                    // _UNPACK, _REPACK ì ‘ë¯¸ì‚¬ ì œê±°
                    const itemCode = (row.item_code || 'Unknown').replace(/_UNPACK$/, '').replace(/_REPACK$/, '');
                    itemQty[itemCode] = (itemQty[itemCode] || 0) + (row.current_qty || 0);
                });

                // ì •ë ¬ ì˜µì…˜ ì ìš©
                const sortOrder = document.getElementById('stockSortOrder')?.value || 'qty-desc';
                let sortedItems = Object.entries(itemQty);

                if (sortOrder === 'qty-desc') {
                    sortedItems.sort((a, b) => b[1] - a[1]);
                } else if (sortOrder === 'qty-asc') {
                    sortedItems.sort((a, b) => a[1] - b[1]);
                } else if (sortOrder === 'name-asc') {
                    sortedItems.sort((a, b) => a[0].localeCompare(b[0]));
                }

                const items = sortedItems.map(([k]) => k);
                const data = sortedItems.map(([, v]) => v);

                const colors = [
                    '#3498db', '#27ae60', '#f39c12', '#e74c3c', '#9b59b6',
                    '#1abc9c', '#e67e22', '#2980b9', '#16a085', '#c0392b'
                ];

                state.charts.warehouseItem = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: items,
                        datasets: [{
                            label: 'ì¬ê³ ëŸ‰',
                            data: data,
                            backgroundColor: items.map((_, i) => colors[i % colors.length]),
                            borderColor: '#fff',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `ì¬ê³ ëŸ‰: ${context.raw.toLocaleString()}`;
                                    }
                                }
                            },
                            datalabels: {
                                anchor: 'end',
                                align: 'top',
                                color: '#333',
                                font: { weight: 'bold', size: 11 },
                                formatter: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    font: { size: 11 },
                                    maxRotation: 0,
                                    minRotation: 0
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'ì¬ê³ ëŸ‰', font: { size: 11 } }
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            }
        }

        function updateTopItemsChart() {
            const ctx = document.getElementById('topItemsChart');
            if (!ctx) return;

            const top5 = state.summaryData.slice(0, 5);
            const labels = top5.map(r => r.item_code);
            const inData = top5.map(r => r.total_in || 0);
            const outData = top5.map(r => r.total_out || 0);
            const disassembleData = top5.map(r => (r.total_disassemble_out || 0) + (r.total_disassemble_in || 0));

            if (state.charts.topItems) state.charts.topItems.destroy();

            state.charts.topItems = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'ì…ê³ ', data: inData, backgroundColor: 'rgba(39, 174, 96, 0.7)' },
                        { label: 'ì¶œê³ ', data: outData, backgroundColor: 'rgba(231, 76, 60, 0.7)' },
                        { label: 'í•´ì²´', data: disassembleData, backgroundColor: 'rgba(124, 58, 237, 0.7)' }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        // ========== íŠ¸ë Œë“œ ==========
        function populateTrendSelect() {
            const select = document.getElementById('trendItemSelect');
            select.innerHTML = '<option value="">í’ˆëª©ì„ ì„ íƒí•˜ì„¸ìš”</option>';

            state.summaryData.forEach(item => {
                const option = document.createElement('option');
                option.value = item.item_code;
                option.textContent = `${item.item_code} - ${item.item_name || ''}`;
                select.appendChild(option);
            });
        }

        function autoSelectTrendItem(searchTerm) {
            // í’ˆëª© ê²€ìƒ‰ì–´ê°€ ìˆê³  ê²°ê³¼ê°€ 1ê°œì¸ ê²½ìš° ìë™ ì„ íƒ
            if (searchTerm && state.summaryData.length === 1) {
                const select = document.getElementById('trendItemSelect');
                select.value = state.summaryData[0].item_code;
                loadItemTrend();
            }
            // ê²€ìƒ‰ì–´ê°€ ìˆê³  ê²°ê³¼ê°€ ì—¬ëŸ¬ ê°œì§€ë§Œ ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” í’ˆëª©ì´ ìˆëŠ” ê²½ìš°
            else if (searchTerm && state.summaryData.length > 0) {
                const exactMatch = state.summaryData.find(
                    item => item.item_code.toLowerCase() === searchTerm.toLowerCase()
                );
                if (exactMatch) {
                    const select = document.getElementById('trendItemSelect');
                    select.value = exactMatch.item_code;
                    loadItemTrend();
                }
            }
        }

        async function loadItemTrend() {
            const itemCode = document.getElementById('trendItemSelect').value;
            if (!itemCode) {
                document.getElementById('trendItemInfo').style.display = 'none';
                return;
            }

            document.getElementById('trendItemInfo').style.display = 'block';

            // í•´ë‹¹ í’ˆëª©ì˜ ë°ì´í„° í•„í„°
            const itemData = state.ledgerData.filter(r => r.item_code === itemCode || r.base_item_code === itemCode);

            // ì›”ë³„ ì§‘ê³„
            const monthlyData = {};
            let totalIn = 0, totalOut = 0;

            itemData.forEach(row => {
                const month = row.date ? row.date.substring(0, 7) : 'Unknown';
                if (!monthlyData[month]) monthlyData[month] = { in: 0, out: 0, count: 0 };
                monthlyData[month].in += row.in_qty || 0;
                monthlyData[month].out += row.out_qty || 0;
                monthlyData[month].count++;
                totalIn += row.in_qty || 0;
                totalOut += row.out_qty || 0;
            });

            document.getElementById('trendTotalIn').textContent = totalIn.toLocaleString();
            document.getElementById('trendTotalOut').textContent = totalOut.toLocaleString();

            // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
            const labels = Object.keys(monthlyData).sort();
            const inData = labels.map(m => monthlyData[m]?.in || 0);
            const outData = labels.map(m => monthlyData[m]?.out || 0);

            const ctx = document.getElementById('trendChart');
            if (state.charts.trend) state.charts.trend.destroy();

            state.charts.trend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'ì…ê³ ', data: inData, borderColor: '#27ae60', backgroundColor: 'rgba(39,174,96,0.1)', fill: true },
                        { label: 'ì¶œê³ ', data: outData, borderColor: '#e74c3c', backgroundColor: 'rgba(231,76,60,0.1)', fill: true }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } },
                    scales: { y: { beginAtZero: true } }
                }
            });

            // í…Œì´ë¸” ì—…ë°ì´íŠ¸
            const tbody = document.getElementById('trendTableBody');
            tbody.innerHTML = labels.reverse().map(month => {
                const d = monthlyData[month];
                const net = d.in - d.out;
                return `
                    <tr>
                        <td class="ps-3">${month}</td>
                        <td class="text-end text-success fw-bold">${d.in.toLocaleString()}</td>
                        <td class="text-end text-danger fw-bold">${d.out.toLocaleString()}</td>
                        <td class="text-end fw-bold ${net >= 0 ? 'text-success' : 'text-danger'}">${net >= 0 ? '+' : ''}${net.toLocaleString()}</td>
                        <td class="text-end pe-3">${d.count}</td>
                    </tr>
                `;
            }).join('');
        }

        function showItemTrend(itemCode) {
            document.querySelector('[data-bs-target="#trendTab"]').click();
            document.getElementById('trendItemSelect').value = itemCode;
            loadItemTrend();
        }

        // ========== í’ˆëª© ëª¨ë‹¬ ==========
        function showItemModal(itemCode, itemName) {
            const modal = new bootstrap.Modal(document.getElementById('itemModal'));
            document.getElementById('itemModalTitle').textContent = `ğŸ“¦ ${itemCode} - ${itemName || ''}`;

            // í•´ë‹¹ í’ˆëª© ë°ì´í„°
            const itemData = state.ledgerData.filter(r => r.item_code === itemCode || r.base_item_code === itemCode);

            let totalIn = 0, totalOut = 0;
            itemData.forEach(r => {
                totalIn += r.in_qty || 0;
                totalOut += r.out_qty || 0;
            });

            const currentStock = state.currentStockData.find(r => r.item_code === itemCode);
            const currentQty = currentStock?.current_qty || 0;

            document.getElementById('itemModalStats').innerHTML = `
                <div class="stat-box"><div class="value qty-in">${totalIn.toLocaleString()}</div><div class="label">ì´ ì…ê³ </div></div>
                <div class="stat-box"><div class="value qty-out">${totalOut.toLocaleString()}</div><div class="label">ì´ ì¶œê³ </div></div>
                <div class="stat-box"><div class="value">${currentQty.toLocaleString()}</div><div class="label">í˜„ì¬ ì”ëŸ‰</div></div>
                <div class="stat-box"><div class="value">${itemData.length}</div><div class="label">ê±°ë˜ ê±´ìˆ˜</div></div>
            `;

            // ì›”ë³„ ë¯¸ë‹ˆ ì°¨íŠ¸
            const monthlyData = {};
            itemData.forEach(row => {
                const month = row.date ? row.date.substring(0, 7) : 'Unknown';
                if (!monthlyData[month]) monthlyData[month] = { in: 0, out: 0 };
                monthlyData[month].in += row.in_qty || 0;
                monthlyData[month].out += row.out_qty || 0;
            });

            const labels = Object.keys(monthlyData).sort().slice(-6);
            const inData = labels.map(m => monthlyData[m]?.in || 0);
            const outData = labels.map(m => monthlyData[m]?.out || 0);

            const ctx = document.getElementById('itemModalChart');
            if (state.charts.itemModal) state.charts.itemModal.destroy();

            state.charts.itemModal = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'ì…ê³ ', data: inData, backgroundColor: 'rgba(39,174,96,0.7)' },
                        { label: 'ì¶œê³ ', data: outData, backgroundColor: 'rgba(231,76,60,0.7)' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });

            // ìµœê·¼ ê±°ë˜ ë‚´ì—­
            document.getElementById('itemModalHistory').innerHTML = itemData.slice(0, 10).map(row => `
                <tr>
                    <td>${formatDate(row.date)}</td>
                    <td>${getTypeBadge(row.stock_entry_type_kr, row.stock_entry_type)}</td>
                    <td class="text-end ${row.in_qty ? 'qty-in' : 'qty-out'}">
                        ${row.in_qty ? '+' + row.in_qty.toLocaleString() : '-' + (row.out_qty || 0).toLocaleString()}
                    </td>
                    <td><small>${row.warehouse}</small></td>
                </tr>
            `).join('');

            modal.show();
        }

        // ========== ìœ í‹¸ë¦¬í‹° ==========
        function getTypeBadge(typeKr, typeEn) {
            let badgeClass = '';
            if (typeEn === 'Material Receipt' || typeEn === 'Manufacture') badgeClass = 'receipt';
            else if (typeEn === 'Material Issue' || typeEn === 'Stock Delivery') badgeClass = 'issue';
            else if (typeEn === 'Material Transfer') badgeClass = 'transfer';
            else if (typeEn === 'ê³µê¸‰ì²˜ë°˜í’ˆ') badgeClass = 'return';
            else badgeClass = 'manufacture';

            return `<span class="type-badge ${badgeClass}">${typeKr || typeEn || ''}</span>`;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            return dateStr.substring(0, 16).replace('T', ' ');
        }

        function formatTime(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const now = new Date();
            const diff = (now - date) / 1000 / 60; // ë¶„

            if (diff < 1) return 'ë°©ê¸ˆ ì „';
            if (diff < 60) return Math.floor(diff) + 'ë¶„ ì „';
            if (diff < 1440) return Math.floor(diff / 60) + 'ì‹œê°„ ì „';
            return Math.floor(diff / 1440) + 'ì¼ ì „';
        }

        function updateLastUpdate() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent =
                'ì—…ë°ì´íŠ¸: ' + now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
        }

        function showToast(title, message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const icons = { in: 'ğŸ“¥', out: 'ğŸ“¤', error: 'âš ï¸', info: 'â„¹ï¸' };

            const toast = document.createElement('div');
            toast.className = 'custom-toast';
            toast.innerHTML = `
                <div class="icon">${icons[type] || icons.info}</div>
                <div class="content">
                    <div class="title">${title}</div>
                    <div class="message">${message}</div>
                </div>
            `;

            container.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }

        function exportExcel(type) {
            const filters = getFilters();
            const endpoint = DEMO_MODE ? 'api/demo/export-excel' : 'api/export-excel';
            const url = API_BASE + endpoint + '?' + buildQueryString(filters) + '&type=' + type;
            window.location.href = url;
        }

        // ========== ìë™ì™„ì„± ê²€ìƒ‰ ==========
        let autocompleteTimeout = null;
        let selectedIndex = -1;

        function toggleClearBtn() {
            const input = document.getElementById('itemSearch');
            const btn = document.getElementById('clearSearchBtn');
            btn.style.display = input.value.length > 0 ? 'block' : 'none';
        }

        function clearSearch() {
            document.getElementById('itemSearch').value = '';
            document.getElementById('clearSearchBtn').style.display = 'none';
            hideAutocomplete();
            loadAllData();
        }

        async function handleItemSearch(event) {
            const input = event.target;
            const dropdown = document.getElementById('itemAutocomplete');
            const query = input.value.trim();

            // Enter í‚¤ ì²˜ë¦¬
            if (event.key === 'Enter') {
                hideAutocomplete();
                loadAllData();
                return;
            }

            // ìœ„/ì•„ë˜ í™”ì‚´í‘œ ì²˜ë¦¬
            if (event.key === 'ArrowDown' || event.key === 'ArrowUp') {
                navigateAutocomplete(event.key === 'ArrowDown' ? 1 : -1);
                return;
            }

            // ESC ì²˜ë¦¬
            if (event.key === 'Escape') {
                hideAutocomplete();
                return;
            }

            // ê²€ìƒ‰ì–´ ì—†ìœ¼ë©´ ìˆ¨ê¹€
            if (query.length < 2) {
                hideAutocomplete();
                return;
            }

            // ë””ë°”ìš´ìŠ¤
            clearTimeout(autocompleteTimeout);
            autocompleteTimeout = setTimeout(() => fetchAutocomplete(query), 200);
        }

        async function fetchAutocomplete(query) {
            const endpoint = DEMO_MODE ? 'api/demo/search-items' : 'api/search-items';
            try {
                const response = await fetch(API_BASE + endpoint + '?q=' + encodeURIComponent(query));
                const items = await response.json();
                showAutocomplete(items);
            } catch (e) {
                console.error('ìë™ì™„ì„± ì˜¤ë¥˜:', e);
            }
        }

        function showAutocomplete(items) {
            const dropdown = document.getElementById('itemAutocomplete');

            if (items.length === 0) {
                hideAutocomplete();
                return;
            }

            selectedIndex = -1;
            dropdown.innerHTML = items.map((item, idx) => `
                <div class="autocomplete-item" data-index="${idx}"
                     onclick="selectAutocomplete('${item.name}')"
                     onmouseenter="selectedIndex = ${idx}; highlightAutocomplete()">
                    <div class="item-code">${item.name}</div>
                    <div class="item-name">${item.item_name || ''}</div>
                </div>
            `).join('');

            dropdown.classList.add('show');
        }

        function hideAutocomplete() {
            document.getElementById('itemAutocomplete').classList.remove('show');
            selectedIndex = -1;
        }

        function selectAutocomplete(itemCode) {
            document.getElementById('itemSearch').value = itemCode;
            hideAutocomplete();
            loadAllData();
        }

        function navigateAutocomplete(direction) {
            const items = document.querySelectorAll('.autocomplete-item');
            if (items.length === 0) return;

            selectedIndex += direction;
            if (selectedIndex < 0) selectedIndex = items.length - 1;
            if (selectedIndex >= items.length) selectedIndex = 0;

            highlightAutocomplete();
        }

        function highlightAutocomplete() {
            const items = document.querySelectorAll('.autocomplete-item');
            items.forEach((item, idx) => {
                item.classList.toggle('selected', idx === selectedIndex);
            });

            // ì„ íƒëœ í•­ëª©ì´ ìˆìœ¼ë©´ ì…ë ¥ì°½ì— í‘œì‹œ
            if (selectedIndex >= 0 && items[selectedIndex]) {
                const code = items[selectedIndex].querySelector('.item-code').textContent;
                document.getElementById('itemSearch').value = code;
            }
        }

        // ì™¸ë¶€ í´ë¦­ ì‹œ ìë™ì™„ì„± ë‹«ê¸°
        document.addEventListener('click', function(e) {
            if (!e.target.closest('#itemSearch') && !e.target.closest('#itemAutocomplete')) {
                hideAutocomplete();
            }
        });
    </script>
</body>
</html>
